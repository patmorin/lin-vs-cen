\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage{todonotes}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
\linenumbers
% \rightlinenumbers
\linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}


\newcommand{\coloured}[2]{{\color{#1}{#2}}}
\newenvironment{colourblock}[1]{\color{#1}}{}

\newcommand{\condref}[1]{(C\ref{#1})}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}


\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\stw}{stw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}

\DeclareMathOperator{\x}{x}
\DeclareMathOperator{\depth}{d}
\DeclareMathOperator{\sh}{cbt}
\DeclareMathOperator{\cbt}{cbt}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\dc}{dc}

\DeclareMathOperator{\afci}{\overline{\chi}_\pi}
\DeclareMathOperator{\afcn}{\dot{\chi}_\pi}

\newcommand{\ellt}{{\lfloor\ell/2\rfloor}}

\title{\MakeUppercase{Linear versus Centered Colouring Numbers}\thanks{This research was partly funded by NSERC.}}
\author{Prosenjit Bose, Vida Dujmović, Mehrnoosh Javarsineh, and Pat Morin}

\date{}

\DeclareMathOperator{\ddiv}{div}
\DeclareMathOperator{\hist}{p}

\newcommand{\colored}[2]{{\color{#1}#2}}

\usepackage{tabularx}

\DeclareMathOperator{\ci}{\overline{\pi}}

\DeclareMathOperator{\chicen}{\chi_{\mathrm{cen}}}
\DeclareMathOperator{\chilin}{\chi_{\mathrm{lin}}}

\begin{document}

% \begin{titlepage}
\maketitle

\begin{abstract}
    These are some notes on the relationships betwee linear colouring numbers and centered colouring numbers.
\end{abstract}
% \end{titlepage}

% \pagenumbering{roman}
% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}



\section{Introduction}

Let $G$ be a simple undirected graph.  A \emph{$k$-colouring} of $G$ is any function $\varphi:V(G)\to S$ where $S$ is a set of size $k$.  A vertex $v$ of $G$ is a \emph{center} of $G$ with respect to $\varphi$ if $\varphi(v)\not\in\{\varphi(w):w\in V(G)\setminus\{v\}\}$, i.e., $v$ is the unique vertex of $G$ having colour $\varphi(v)$.  The colouring $\varphi$ is \emph{centered} if every connected sugraph $H\subseteq G$ has a center.  The colouring $\varphi$ is \emph{linear} if every simple path $P\subseteq G$ has a center. 

The \emph{centered chromatic number} $\chicen(G)$ of $G$ is the minimum integer $c$ such that $G$ has a centered $c$-colouring.  The \emph{linear chromatic number} of $G$ is the minimum integer $\ell$ such that $G$ has a linear $\ell$-colouring.  Since every path in $G$ is a connected subgraph of $G$, every centered colouring of $G$ is also a linear colouring of $G$, so $\chilin(G)\le\chicen(G)$.

The question of upper bounding $\chicen(G)$ by some function of $\chilin(G)$ was considered by \citet[Theorem~1]{kun.obrien.ea:polynomial} who showed the following result:

\begin{thm}[\citet{kun.obrien.ea:polynomial}]\label{kun-obrien-general}
  For any graph $G$, $\chicen(G)\le \chilin^{190}(G)\cdot\log^{O(1)}(\chilin(G))$.  
\end{thm}
  
  
Their proof of \cref{kun-obrien-general} has three steps:
\begin{enumerate}
  \item A theorem of \citet{kawarabayashi.rossman:polynomial} shows that, if $\chicen(G)\ge k^{190}\log^{O(1)} k$ then $\chilin(G)\ge k^{38}$ or $G$ has treewidth $\tw(G)\ge k^{38}$.  In the former case there is nothing left to prove.
  \item The current-best version of the Excluded Grid Theorem due to \citet{chuzhoy:improved} shows that, if $\tw(G)\ge k^{38}$, then $G$ contains an $\Omega(k^2\times k^2)$ grid minor.
  \item A technical lemma \cite[Lemma~5]{kun.obrien.ea:polynomial} shows that, if $G$ contains a $k^2\times k^2$ grid minor, then $\chilin(G)\in\Omega(k)$.
\end{enumerate}

These notes are an attempt to improve the bound in \cref{kun-obrien-general} in the general case as well as for some special classes of graphs.  

As a first step, we attempt to improve the third part of the argument to show that, if $G$ contains a $k\times k$ grid minor, then $\chilin(G)\in \Omega(k)$.  This, by itself, reduces the exponent in \cref{kun.obrien.general} from $190$ to $95$.  Next, we observe that the first two parts of the argument are both ``heavy hammers'' and that, for some special graph classes, much lighter hammers suffice.  For example, if we consider only planar graphs, then it is well known that any planar graph $G$ of treewidth $k$ contains an $\Omega(k\times k)$ grid minor.  This already reduces the exponent further (for planar graphs) to $5$.  If one could prove a similar result for the first ``heavy hammer'' then this would show that, for any planar graph $G$, $\chicen(G)\in O(\chilin(G))$.

\section{The Linear Colouring Number of Pseudogrids}

A \emph{subdivision} $G'$ of a graph $G$ is any graph that can be obtained from $G$ by repeatedly replacing some edge edge $uw$ of $G$ with a path $uvw$, where $v\not\in V(G)$ is a newly introduced degree-$2$ vertex.  Alternatively, $G'$ is obtained from $G$ by replacing some of the edges of $G$ with paths whose internal vertices have degree $2$.

The $k\times k$ grid graph $G_k$ is the graph with vertex set $V(G_k):=\{1,\ldots,k\}^2$ and that contain an edge with endpoints $(v,w)$ and $x,y$ if and only $|v-x|+|w-y|=1$.  A graph $H$ is a $k\times k$ \emph{pseudogrid} if there exists a set $\mathcal{P}$ of vertex-disjoint paths in $G$ such that the quotient graph $H':=H/\mathcal{P}$ is isomorphic to a subdivision of $G_k$.  Since $G_k$ has maximum degree $4$ any graph $G$ that contains a $G_k$-minor contains a subgraph $H$ that is a $k\times k$ pseudogrid.


\begin{lem}
  For any $k\times k$ pseudogrid $H$, $\chilin(G)\in\Omega(k)$.
\end{lem}

\begin{proof}
  Let $\varphi:V(H)\to\{1,\ldots,c\}$ be an arbitrarily $c$-colouring of some $k\times k$ pseudogrid $H$ for some $c\le \epsilon k$, where $\epsilon$ is a small positive constant.  We will show that $H$ contains a path $P$ which has no center with respect to $c$.  First we introduce some notations: 

  For each vertex $v$ of $G_k$ there is a path $P_v$ in $\mathcal{P}$ (possibly consisting of one vertex) such that the vertex $v$ appears in $H'$ as a result of contracting $P_v$ in $H$.  In this way, each vertex $v$ of $G_k$ is associated with a non-empty \emph{colour set} $\phi(v):=\{\varphi(w):w\in V(P_v)\}$.  Similarly, for each edge $e$ of $G_k$ there is a path $P_e$ in $H'$ that comes from subdividing $e$.  Thus, each edge $e$ of $G_k$ is associated with (possibly empty) \emph{colour set} $\phi(e):=\{\varphi(w):w\in P^-_e\}$, where $P^-_e$ denotes the (possibly empty) set of internal vertices on the path $P_e$.
  
  For each colour $\alpha\in\{1,\ldots,c\}$, define the \emph{multiplicity} of $\alpha$ as the number of vertices and edges of $G_k$ that include $\alpha$ in their colour set.  Fix some large integer constant $A$ and say that $\alpha$ is \emph{infrequent} if it has multiplicity at most $A$.  
  
  If there exists some infrequent colour $\alpha\in\{1,\ldots,c\}$, we identify every row and column of $G_k$ that contains an edge or vertex with $\alpha$ in its colour set.  We then \emph{remove} each of these (at most $A$) rows and columns from $H$ by removing all edges of $H$ in $P_e$ for each $e$ in the relevant row (column) of $G_k$ and then discarding any isolated vertices.  After doing this for each row and column containing $\alpha$, the graph $H$ may be disconnected.  We discard any isolated vertices and any path $P_{v}$ that is disconnected from the rest of $H$.  
  
  The resulting graph $\tilde{H}$ contains a $k'\times k'$ pseudogrid for some $k' \le k-A$ and contains no vertex of colour $\alpha$.  We then set $H\gets \tilde{H}$, $k\gets k'$ and repeat this process until eventually obtain a new $k'\times k'$ pseudogrid $\tilde{H}$ for some $k'\ge k-cA\ge (1-\epsilon A)k \ge k/2$, for $\epsilon \le 1/2A$.  From this point onward that that there is no infrequent colour, i.e., every colour $\alpha\in\{1,\ldots,c\}$ has multiplicity at least $A$.
  
  Next we run a two stage process that, for each $\alpha\in\{1,\ldots,c\}$, will identify a pair of vertices $v_\alpha,w_\alpha$ in $H$ whose colour is $\alpha$.  These pairs are carefully chosen so that we can construct a simple path $P$ in $H$ that contains $\bigcup_{\alpha\in\{1,\ldots,c\}} \{v_\alpha,w_\alpha\}$.  
  
  \begin{compactenum}[Stage 1]
    \item We begin this stage by defining each edge and vertex of $G_k$ as being initially \emph{unmarked}.  Fix some constant $B>0$.  We iterate over each $\alpha\in\{1,\ldots,c\}$ in turn.  If $G_k$ contain a pair $(x_\alpha,y_\alpha)$ where each of $x_\alpha$ and $y_\alpha$ is an unmarked vertex or unmarked edge of $G_k$ with $\alpha$ in its colour set and the distance in $G_k$ between $x_\alpha$ and $y_\alpha$ is at least $B$ then Stage~1 \emph{succeeds} for $\alpha$.  In this case, we take $v_\alpha$ to be any vertex in $P_{x_\alpha}$ of colour $\alpha$ and $w_\alpha$ to be any vertex in $P_{y_\alpha}$ of colour $\alpha$.  We then \emph{mark} every vertex and edge of $G_k$ whose distance from $x_\alpha$ or $y_\alpha$ is less than $B$.
    
    If $G_k$ contains no such pair $(x_\alpha,y_\alpha)$, then we leave $v_\alpha$ and $w_\alpha$ undefined and say that Stage~1 \emph{failed} for colour $\alpha$.

    \item Let $S\subset\{1,\ldots,c\}$ be the set of colours $\alpha$ for which Stage~1 succeeded and let $\overline{S}:=\{1,\ldots,c\}\setminus S$ be the set of colours for which Stage~1 failed.  We construct a bipartite graph $K$ with parts $L(K):=\overline{S}$ and $R(K):=\bigcup_{\alpha\in S}\{x_\alpha,y_\alpha\}$.   For each marked vertex or edge $z$ of $G_k$, let $s(z)$ be the vertex in $R(k)$ that is closest to $z$ in $G_k$.\todo{Gotta be really precise here to avoid degree 3 issue.}  The edge set of $K$ contains an edge $\alpha\beta$ precisely when there is a marked edge or vertex $z$ of $G_k$ such that $\alpha\in\phi(z)$ and $s(z)=\beta$.
    
    
    \begin{clm}
      $K$ contains two matchings $M_1$ and $M_2$ such that each vertex in $L(K)$ appears in each of $M_1$ and $M_2$ and each vertex in $R(k)$ appears in at most one of $M_1$ or $M_2$.
    \end{clm}
    
    \begin{proof}
      Use Hall's Mathcing Theorem/Lemma.
    \end{proof}
    
    Finally, for each $\alpha\in\overline{S}$, we define $x_\alpha$ to be the the unique element of $R(K)$ such that $M_1$ includes the edge $\alphax_\alpha$ and we define $y_\alpha$ to be the unique element of $R(K)$ such that $M_2$ includes the edge $\alpha y_\alpha$.  We define $v_\alpha$ and $w_\alpha$ as before.
    
    Now, let $R:=\bigcup_{\alpha\in\{1,\ldots,c\}} \{x_\alpha,y_\alpha\}$.
    
    \begin{clm}
        There is no vertex of $G_k$ that has three or more incident edges in $R$.
    \end{clm}
    
    \begin{clm}
        Each $B/2\times B_/2$ subgrid of $G_k$ contains at most four elements of $R$.
    \end{clm}
    
    Now classify each vertex of $G_k$ as either being \emph{straight} or \emph{bent}. Define what it means for a path $P$ to go straight or bend at a vertex.  Now we should be able to finish with this lemma:
    
    \begin{lem}
        $G_k$ contain a simple path $P$ that contains every edge and vertex in $R$.  Furthermore, $P$ bends at each bent vertex in $R$ and $P$ goes straight at each straight vertex in $R$. 
    \end{lem}
  
\end{proof}







\bibliographystyle{plainurlnat}
\bibliography{lin-vs-cen}




\end{document}




Two words $s$ and $t$ are \emph{anagrams} of each other if $s$ is a permutation of $t$.  A single word $w:=w_1,\ldots,w_{2r}$ is \emph{anagramish} if its first half $w_1,\ldots,w_r$ and its second half $w_{r+1},\ldots,w_{2r}$ are anagrams of each other.  A word is \emph{anagram-free} if it does not contain an anagramish factor.  Anagramish words are also known as \emph{abelian squares} and anagram-free words are also known as \emph{abelian square free} words \cite{keranen:abelian,keranen:powerful}, \emph{strongly nonrepetitive} words \cite{pleasants:non-repetitive}, or \emph{strongly asymmetric} sequences \cite{evdokimov:strongly,evdokimov:strongly2}.

In 1961, \citet{erdos:some} asked if there exist arbitrarily long words over an alphabet of size $4$ that are anagram-free.\footnote{This was an incredibly prescient question since it is not at all obvious that there exist arbitrarily long anagram-free words over \emph{any} finite alphabet. The only justification for choosing the constant $4$ is that a short case analysis rules out the possibility of length-$8$ anagram-free words over an alphabet of size $3$.}  In 1968 \citet{evdokimov:strongly,evdokimov:strongly2} showed the existence of arbitrarily long anagram-free words over an alphabet of size $25$ and in 1971 \citet{pleasants:non-repetitive} showed an alphabet of size $5$ is sufficient.  Erd\H{o}s's question was not fully resolved until 1992, when \citet{keranen:abelian} answered it in the affirmative.

A path $v_1,\ldots,v_{2r}$ in a graph $G$ is \emph{anagramish} under a vertex $c$-colouring $\phi:V(G)\to\{1,\ldots,c\}$ if $\phi(v_1),\ldots,\phi(v_{2r})$ is an anagramish word.  The colouring $\phi$ is an \emph{anagram-free colouring} of $G$ if no path in $G$ is anagramish under $\phi$.  The minimum integer $c$ for which $G$ has an anagram-free vertex $c$-colouring is called the \emph{anagram-free chromatic number} of $G$ and is denoted by $\afcn(G)$.

For a graph family $\mathcal{G}$, $\afcn(\mathcal{G}):=\max\{\afcn(G):G\in\mathcal{G}\}$ or $\afcn(\mathcal{G}):=\infty$ if the maximum is undefined. The results on anagram-free words discussed in the preceding paragraph can be interpreted in terms of $\afcn(\mathcal{P})$ where $\mathcal{P}$ is the family of all paths. Indeed, Ker\"anen's result shows that $\afcn(\mathcal{P})\le 4$. Slightly more complicated than paths are trees.  \citet{wilson.wood:anagram-free} showed that $\afcn(\mathcal{T})=\infty$ for the family $\mathcal{T}$ of trees and \citet{kamcev.luczak.ea:anagram-free} showed that $\afcn(\mathcal{T}_2)=\infty$ even for the family $\mathcal{T}_2$ of binary trees.

One positive result in this context is that of
\citet{wilson.wood:anagram-free}, who showed that every tree $T$ of pathwidth $p$ has $\afcn(T)\le 4p+1$. Since trees are graphs of treewidth $1$ it is natural to ask if this result can be extended to show that every graph $G$ of treewidth $t$ and pathwidth $p$ has $\afcn(G)\le f(t,p)$ for some function $f:\N^2\to\N$.  \citet{carmi.dujmovic.ea:anagram-free} showed that such a generalization is not possible for any $t\ge 3$ by giving examples of $n$-vertex graphs of pathwidth $3$ (and treewidth $3$) with $\afcn(G)\in\Omega(\log n)$.  The obvious remaining gap left by these two works is graphs of treewidth $2$. Our main result is to show that $G_n$, the $2\times n$ square grid has $\afcn(G_n)\in\omega_n(1)$. Since $G_n$ has pathwidth 2, we have:

\begin{thm}\label{main_vertex}
    For every $c\in\N$, there exists a graph of pathwidth $2$ that has no anagram-free vertex $c$-colouring.
\end{thm}

\citet[Section 7.1]{wilson:anagram-free} conjectured that $\afcn(G_n)\in\omega_n(1)$, so this work confirms this conjecture.  Prior to the current work, it was not even known if the family of $n\times n$ square grids had anagram-free colourings using a bounded number of colours.

In a larger context, this lower bound gives more evidence that, except for a few special cases (paths \cite{evdokimov:strongly,pleasants:non-repetitive,keranen:abelian}, trees of bounded pathwidth \cite{wilson.wood:anagram-free}, and highly subdivided graphs \cite{wilson.wood:anagram-free2}), the qualitative behaviour of anagram-free chromatic number is not much different than that of treedepth/centered colouring \cite{nesetril.ossona:tree-depth}.  Very roughly: For most graph classes, every graph in the class has an anagram-free colouring using a bounded number of colors precisely when every graph in the class has a colouring using a bounded number of colours in which every path contains a colour that appears only once in the path.

% \todo[inline]{Statement of vertex colouring result (hopefully)}
%
% An \emph{edge $c$-colouring} $\varphi:E(G)\to\{1,\ldots,c\}$ is \emph{anagram-free} if $G$ has no path $v_0,\ldots,v_{2r}$ such that $\varphi(v_0v_1),\ldots,\varphi(v_{2r-1}v_{2r})$ is anagramish.  We also give an edge colouring version of \cref{main_vertex}.
%
% \begin{thm}\label{main_edge}
%     For every $c\in\N$, there exists a graph of $G$ of pathwidth $2$ that has no anagram-free edge $c$-colouring.
% \end{thm}


% \todo[inline]{Relation to Existing Work}

The remainder of this paper is organized as follows: \Cref{near_anagram_statement} gives some definitions and states a key lemma which shows, under a certain periodicity condition, that every sufficiently long word contains a factor that is $\epsilon$-close to being anagramish.
% In \cref{edge_colourings} we prove \cref{main_edge}.
In \cref{vertex_colourings} we use this key lemma to prove \cref{main_vertex}.  In \cref{near_anagram_proof} we prove the key lemma. \cref{reflections} concludes with some final remarks about the (non-)constructiveness of our proof technique.

\section{Periodicity in words}
\label{near_anagram_statement}

An \emph{alphabet} $\Sigma$ is a finite non-empty set and each element of $\Sigma$ is called a \emph{letter}. A \emph{word} over $\Sigma$ is a (possibly empty) sequence $w:=w_1,\ldots,w_n$ with $w_i\in\Sigma$ for each $i\in\{1,\ldots,n\}$. The \emph{length} $|w|$ of $w$ is the length, $n$, of the sequence.  A word of length at least $1$ is \emph{non-empty}.  The unique word of length $0$ is denoted by $\varepsilon$. For a word $w:=w_1,\ldots,w_n$, we let $\Sigma_w:=\{w_i:i\in\{1,\ldots,n\}\}$.  For each $1 \le i \le j\le n+1$, $w_i,w_{i+1},\ldots,w_{j-1}$ is called a \emph{factor} of $w$.\footnote{Note that this definition includes the empty factor $\varepsilon$ obtained when $i=j$.}  The set of all factors of $w$ is denoted by $F(w)$.

A \emph{language} $L$ over $\Sigma$ is a set of words over $\Sigma$.  A language $L$ is \emph{infinite} if $|L|=\infty$.  We let $\Sigma_L:=\bigcup_{w\in L}\Sigma_w$ and $F(L):=\bigcup_{w\in L}F(w)$.  The language $L$ is \emph{factor-closed} if $F(w)\subseteq L$ for each $w\in L$.  For any alphabet $\Sigma$ and any $k\in\N$, $\Sigma^k$ (the $k$-fold cartesian product of $\Sigma$ with itself) is the language consisting of all length-$k$ words over $\Sigma$.  The \emph{Kleene closure} $\Sigma^*:=\bigcup_{k=0}^\infty \Sigma^k$ is the language consisting of all words over $\Sigma$.

 % (Note the convention that $w[i\mathbin{:}j]$ does not include $w_j$, so $w[i\mathbin{:}j]$ has length $j-i$.)\todo{Is this notation still needed after revisions?}

Let $w:=w_1,\ldots,w_n$ be a word over an alphabet $\Sigma$ and, for each $a\in \Sigma$, define $|w|_a:=|\{i\in\{1,\ldots,n\}:w_i=a\}|$.  The \emph{Parikh vector} of $w$ is the integer-valued $|\Sigma|$-vector $\hist(w):=(|w|_{a}:a\in\Sigma)$ that is indexed by elements of $\Sigma$.  Observe that a word $w_1,\ldots,w_{2r}$ is anagramish if and only if $\hist(w_1,\ldots,w_r)=\hist(w_{r+1},\ldots,w_{2r})$ or, equivalently, $\hist(w_1,\ldots,w_r)-\hist(w_{r+1},\ldots,w_{2r})=\boldsymbol{0}$.
% Let $\|\cdot\|_1$ denote the L1 norm of a vector.\footnote{The L1 norm of a real-valued $d$-vector $\boldsymbol{v}:=(v_1,\ldots,v_d)$, $\|\boldsymbol{v}\|_1=\sum_{i=1}^d|v_i|$.}
For each $a\in\Sigma$, let $\delta_a(w):=|w_1,\ldots,w_r|_{a}-|w_{r+1},\ldots,w_{2r}|_{a}$ and let $\tau_a(w):=|\delta_a|$.
Then $\tau(w):=\sum_{a\in\Sigma}\tau_a(w)$ is a useful measure of how far a word is from being anagramish and that $\tau(w)=0$ if and only if $w$ is anagramish.

A word $w:=w_1,\ldots,w_n$ is \emph{$\ell$-periodic} over an alphabet $\Sigma\supseteq\Sigma_w$ if each length-$\ell$ factor of $w$ contains every letter in $\Sigma$.  A language $L$ is \emph{$\ell$-periodic}  if each of its words is $\ell$-periodic over $\Sigma_L$.  A language $L$ is \emph{periodic} if it is $\ell$-periodic for some finite $\ell$.  We make use of the following key lemma, which states that every sufficiently long $\ell$-periodic word contains arbitrarily long factors that are $\epsilon$-close to being anagramish.

\begin{lem}\label{near_anagram_fourier}
    For each $r_0,\ell\in\N$ and each $\epsilon>0$, there exists a positive integer $n$ such that each $\ell$-periodic word $w_1,\ldots,w_n$ contains a factor $w:=w_{i+1},\ldots,w_{i+2r}$ of length $2r \ge 2r_0$ such that $\tau(w)\le \epsilon r$.
\end{lem}

The proof of \cref{near_anagram_fourier} is deferred to \cref{near_anagram_proof}.  We now give some intuition as to how it is used.  The process of checking if a word is anagramish can be viewed as finding common letters in the first and second halves and crossing them both out.  If this results in a complete cancellation of all letters, then the word is an anagram.  \cref{near_anagram_fourier} tells us that we can always find a long factor $w$ where, after exhaustive cancellation, only an $\epsilon$-fraction of the original letters remain.
% Informally, the factor $w$ is $\epsilon$-close to being anagramish.

\cref{near_anagram_fourier} says that, if up to $\epsilon r$ letters in each half of $w$ were each allowed to cancel two letters of the same letters in the other half of $w$, then it would be possible to complete the cancellation process.  To achieve this type of one-versus-two cancellation in our setting, we decompose our coloured pathwidth-$2$ graph into pieces of constant size.  The vertices in each piece can be covered with one path or partitioned into two paths (see \cref{paths}).  In this way an occurrence $H_z$ of a particular coloured piece in one half can be matched with two like-coloured pieces $H_x$ and $H_y$ in the other half. We construct a single path $P$ that contains all vertices in $H_z$ and only half the vertices in each of $H_x$ and $H_y$.  In this way, the colours of vertices $P\cap H_z$ can cancel the colours of the vertices in $P\cap(H_x\cup H_y)$.

Since \cref{near_anagram_fourier} requires that the word $w$ be $\ell$-periodic, the following lemma will be helpful in obtaining words that can be used with \cref{near_anagram_fourier}. (Although \cref{periodicity} follows immediately from considerably stronger results in combinatorics on words---for example \citet[Proposition~1.5.12]{lothaire:algebraic}---we provide a proof here for the sake of completeness.)


\begin{lem}\label{periodicity}
    Let $L$ be an infinite factor-closed language over an alphabet $\Sigma$.  Then there exists an infinite periodic factor-closed language $M\subseteq L$.
\end{lem}


\begin{proof}
    Let $\Xi\subseteq\Sigma$ be any minimal subset of $\Sigma$ with the property that $M:=\Xi^* \cap L$ is infinite.  Observe that, since $L$ is factor closed, $M$ is also factor-closed.  Therefore $M$ is infinite and factor-closed.  All that remains is to show that $M$ is $\ell$-periodic for some integer $\ell$.

    Since $\Xi$ is minimal, $\Pi^*\cap L$ is finite for any strict subset $\Pi\subsetneq \Xi$.  Since $L$ is factor-closed, $\Pi^*\cap L$ is factor-closed.  Since $\Pi^*\cap L$ is factor-closed and finite, $|w|$ is finite for each $w\in\Pi^*\cap L$.
    Therefore, the value
    \begin{equation}
        \ell:=1+\max\{|w|: w\in \Pi^*\cap L,\, \Pi\subsetneq\Xi\} \label{l-def}
    \end{equation}
    is finite.  Now, consider any factor $f$ of any word in $M$ that does not contain every letter of $\Xi$, i.e., $f\in\Pi^*$ for some  $\Pi\subsetneq\Xi$.  Since $\Pi^*\cap L$ is factor closed, $f\in \Pi^*\cap L$ so, by \cref{l-def}, $|f| < \ell$.  Contrapositively, any factor of length at least $\ell$ of any word in $M$ contains every element of $\Xi$, so $M$ is $\ell$-periodic.
\end{proof}


\section{Proof of \cref{main_vertex}}
\label{vertex_colourings}

For each $n\in\N$, let $G_n$ be the $2\times n$ square grid with top row $a_0,\ldots,a_{n-1}$ and bottom row $b_0,\ldots,b_{n-1}$ (see \cref{g_n}).  For the sake of contradiction, suppose that there exists an integer $c$ such that $\afcn(G_n)\le c$ for each $n\in\N$.  Observe that there is a bijection between vertex $c$-colourings of $G_n$ and words of length $2n$ over the alphabet $\Sigma_0:=\{1,\ldots,c\}$ where a word $w:=w_0,\ldots,w_{2n-1}$ corresponds to the colouring $\phi_w:V(G_n)\to\{1,\ldots,c\}$ defined by
$\phi_w(a_i):=w_{2i}$ and $\phi_w(b_i):=w_{2i+1}$, for each $i\in\{0,\ldots,n-1\}$.

\begin{figure}
    \centering{
        \includegraphics{figs/g_n}
    }
    \caption{The graph $G_n$}
    \label{g_n}
\end{figure}


% Let $L_0\subseteq \Sigma_0^*$ consist of all words $w\in \Sigma_0^*$ whose length is a multiple of $8$ and such that $\phi_w$ is an anagram-free colouring of $G_{|w|/2}$. Furthermore, the assumption that $\afcn(G_n)\le c$ for each $n\in\N$ implies that $L_0$ is infinite.

For reasons that will become apparent, it is useful to break $G_n$ up into blocks consisting of $4$ columns each.  Let $\Sigma_1:=\Sigma_0^8$ and define the language $L_1$ to consist of exactly those words $w_1,\ldots,w_r\in \Sigma_1^*$ for which $\phi_{w_1\cdots w_r}$ is an anagram-free colouring of $G_{4r}$.  From the assumption that $\afcn(G_n)\le c$ for all $n\in\N$, it follows that $L_1$ is infinite.  From the definition of anagram-free colouring, it follows that $L_1$ is factor-closed.

By \cref{periodicity}, there exists an infinite periodic factor-closed language $L_2\subseteq L_1$.  Let $x$ be any letter in $\Sigma_{L_2}$.  Note that the word $xx$ is not in $L_2$ since the corresponding colouring $\phi_{xx}$ of $G_8$ has, for example, the anagramish path $a_0,\ldots,a_7$.  Since $L_2$ is factor-closed, no word in $L_2$ contains $xx$ as a factor, i.e., $xx\not\in F(L_2)$.

Let $\Sigma_3\subset F(L_2)$ contain only those factors of $L_2$ that do not contain $x$.  Thus, any word in $L_2$ is of the form $w_0xw_1xw_2\cdots xw_rxw_{r+1}$ where each of $w_1,\ldots,w_{r}$ is in $\Sigma_3$ and each of $w_0,w_{r+1}$ is in $\Sigma_3\cup\{\varepsilon\}$.  Since $L_2$ is periodic, each word in $\Sigma_3$ has bounded length, so $\Sigma_3$ is finite, i.e., $\Sigma_3$ is an alphabet.  Let $L_3$ be the language consisting of all words $w_1,\ldots,w_r\in\Sigma_3^*$ such that $xw_1xw_2\cdots xw_r\in L_2$.  Since $L_2$ is infinite and each word in $L_2$ has the form described above, $L_3$ is infinite.  Since $L_2$ is factor closed, $L_3$ is also factor-closed. Therefore, by \cref{periodicity}, there exists an infinite periodic factor-closed language $L\subseteq L_3$ over the alphabet $\Sigma:=\Sigma_{L_3}$.

See \cref{bigexample} for what follows. Each word $w:=w_1,\ldots,w_r\in L$ defines a word $w':=xw_1xw_2\cdots xw_{r}\in L_1$.  In graph colouring terms, $w$ defines an integer $n_w:=4r+\tfrac{1}{2}\sum_{i=1}^r|w_i|$ and an anagram-free colouring $\phi_w:=\phi_{w'}$ of $G_{n_w}$. The word $w'$ partitions the columns of $G_{n_w}$ into \emph{blocks}, each of which corresponds to a letter $a$ of $w'$ and whose length $|a|/2$ is a multiple of $4$.  There are two types of blocks:
\begin{compactitem}
    \item There are \emph{boring} blocks $Q_0,\ldots,Q_{r-1}$, each containing $4$ columns of $G_{n_w}$, and each corresponding to an occurrence of $x$ in $w'$.
    \item There are \emph{colourful blocks} $H_1,\ldots,H_r$, where $H_i$ is the subgraph of $G_{n_w}$ corresponding to $w_i$ and contains $4|w_i|$ columns of $G_{n_w}$.
\end{compactitem}

\begin{figure}
    \centering{\includegraphics{figs/bigexample-1}}
    \caption{A word $w:=dabacbdabc$, its corresponding word $w':=xdxaxbxaxcxbxdxaxbxc$, and its corresponding coloured graph $G_{n_w}$.}
    \label{bigexample}
\end{figure}

Since $L$ is periodic, there exists an integer $\ell$ such that every word in $L$ is $\ell$-periodic.  Since $L$ is infinite, it contains arbitrarily long words.  These two facts, along with \cref{near_anagram_fourier} immediately imply the following lemma:

\begin{lem}\label{near_anagram_graph}
    If $\afcn(G_n)\le c$ for each $n\in\N$ then, for each $r_0\in\N$ and $\epsilon>0$, there exists $w\in L$ with even length $|w|\ge 2r_0$ and $\tau(w)\le\epsilon r$.
\end{lem}


% \begin{proof}
%     By \cref{block_colouring}, for each $k\in\N$ there exists an $\ell$-periodic word $w'\in\Sigma^k$ such that $\phi_{s'}$ is an anagram-free vertex colouring of $G_{n_{s'}}$. Applying \cref{near_anagram_fourier} to $w'$ proves the existence of the desired word $w$.
% \end{proof}

\cref{near_anagram_graph} shows the existence of a colouring $\phi_w$ of $G_n$ (for arbitrarily large $n$) that is defined by a word $w$ that is $\epsilon$-close to being anagramish.  This implies that the path $P_0:=a_1,\ldots,a_{n}$ is $4\epsilon$-close to being anagramish under $\phi_w$.  The last step, done in the next lemma, is to show that there is enough flexibility to modify $P_0$ to obtain a path is anagramish under $\phi_w$.

\begin{lem}\label{anagramish_path}
    There exists $\epsilon>0$ and $r_0\in\N$ such that, for any $w\in L$ with even length $|w|\ge 2r_0$ and $\tau(w)\le\epsilon r$, the graph $G_{n_w}$ contains a path that is anagramish under $\phi_w$.
\end{lem}

\begin{proof}
    Let $w:=w_1,\ldots,w_{2r}$ so that the colouring $\phi_w$ is defined by the word $xw_1xw_2\cdots xw_r$ (and $r\ge r_0$).
    For each $a\in\Sigma$, define sets $A_a\subseteq\{i\in \{1,\ldots,r-1\}: w_i=a\}$ and $B_a\subseteq\{i\in\{r+1,\ldots,2r-1\}:w_i=a\}$ as follows:
    \begin{compactenum}
        \item If $\delta_a(w)=0$ then $A_a=B_a=\emptyset$.
        \item If $\delta_a(w)>0$ then $|A_a|=2\delta_a(w)=2|B_a|$.
        \item If $\delta_a(w)<0$ then $|A_a|=\delta_a(w)=\tfrac{1}{2}|B_a|$.
    \end{compactenum}
    Let $A:=\bigcup_{a\in\Sigma} A_a$ and $B:=\bigcup_{a\in\Sigma} B_a$.
    The sets $A_a$ and $B_a$ are chosen so that $A\cup B$ satisfies the following \emph{global independence constraint}:  There is no pair $i,j\in A\cup B$ such that $i-j=1$.  To see that this is possible, first observe that, because $r$ is not in $A$ or $B$ we need only concern ourselves with pairs where both $i,j\in\{1,\ldots,r-1\}$ or pairs where both $i,j\in\{r+1,\ldots,2r-1\}$.  Thus, we can choose the elements of $A_a$, for each $a\in\Sigma$ and then independently choose the elements of $B_a$, for each $a\in\Sigma$.

    We show how to choose the elements of $A_a$ for each $a\in\Sigma$.  The same method works for choosing the elements in $B_a$. Observe that, because $w\in L$, $w$ is $\ell$-periodic, so $|\{i\in \{1,\ldots,r-1\}:w_i=a\}|\ge \lfloor(r-1)/\ell\rfloor$ for each $a\in\Sigma$.  This allows us to greedily choose the elements in $A_a$ for each $a\in\Sigma$. At each step we simply avoid choosing $i$ if $i-1$ or $i+1$ have already been chosen in some previous step.  At any step in the process, at most $\epsilon r$ elements have already been chosen in previous steps and each of these eliminates at most $2$ options.  Therefore, there will always be an element available to choose, provided that $2\epsilon r < \lfloor(r-1)/\ell\rfloor$.  In particular, for any $r\ge r_0\ge \ell$, $\epsilon < 1/(4\ell)$ works.

    To ease notation, let $G:=G_{n_w}$.  We now construct the anagramish path $P$ in a piecewise fashion.  Refer to \cref{path_construction}.  For each $i\in\{1,\ldots,2r\}$, let $H_i$ be the subgraph of $G$ induced by the vertices corresponding to $w_i$. (The subgraph $H_1,\ldots,H_{2r}$ are referred to above as colourful blocks.)
    \begin{figure}
        \centering{
            \includegraphics{figs/bigexample-1} \\
            \includegraphics{figs/bigexample-2} \\
            \includegraphics{figs/bigexample-3} \\
            \includegraphics{figs/bigexample-4}
        }
        \caption{Constructing the anagramish path $P$:
            (1) pairs of top and bottom paths are matched with zig-zag paths;
            (2) all remaining colourful blocks receive top paths;
            (3) all boring blocks receive top, updown, or downup paths.
        }
        \label{path_construction}
    \end{figure}
    \begin{compactenum}
        \item For each $a\in\Sigma$ such that $\delta_a(w)>0$, group the elements of $A_a$ into pairs.  For each pair $(i,j)$, $P$ contains the path through the top row of $H_i$ and the path through the bottom row of $H_j$.  For each element $i\in B_a$, $P$ contains the zig-zag path with both endpoints in the top row of $H_i$ and that contains every vertex of $H_i$.  (Note that the zig-zag path begins at the top and ends at the bottom row because $H_i$ contains an even number of columns of $G$.)

        \begin{figure}
            \centering{
                \begin{tabular}{ccc}
                    \includegraphics{figs/paths-1} &
                    \includegraphics{figs/paths-2} &
                    \includegraphics{figs/paths-3}
                \end{tabular}
            }
            \caption{Subpaths of $P$ through colourful blocks: A pair of top and bottom paths contribute the same amount as a single zig-zag path.}
            \label{paths}
        \end{figure}

        % \todo[inline]{Handle this comment: • fig. 4. Maybe do not use the same color for the bottom and the top, it took me a while to notice that the shapes were different and that this meant that the colors were different (or you could simply add a sentence to clarify this).
        % PM: I handled this by making the symbols huge}

        \item For each $a\in\Sigma$ such that $\delta_a(w)<0$ we proceed symmetrically to the previous case, but reversing the roles of $A_a$ and $B_a$.  Specifically, we group the elements of $B_a$ into pairs.  For each pair $(i,j)$, $P$ contains the path through the top row of $H_i$ and the path through the bottom row of $H_j$.  For each element $i\in A_a$, $P$ contains the zig-zag path with both endpoints in the top row of $H_i$ and that contains every vertex of $H_i$.

        \item For each $i\in\{1,\ldots,2r\}\setminus\bigcup_{a\in\Sigma}(I_a\cup B_a)$, $P$ contains the top row of $H_i$.
    \end{compactenum}
    The rules above define the intersection, $P_i$, of $P$ with each colourful block $H_i$ of $G_{n_s}$.  If $P_i$ is the path through the bottom (top) row of $H_i$ then we call $H_i$ a \emph{bottom (top) block}.  If $P_i$ is the zig-zag path that contains every vertex of $H_i$ then we call $H_i$ a \emph{zig-zag block}.  Note that $\sum_{a\in\Sigma} \delta_a = 0$ and this implies that the number of bottom blocks among $H_1,\ldots,H_{r-1}$ is the same as the number of bottom blocks among $H_{r+1},\ldots,H_{2r}$.  Indeed, this number is exactly $\beta:=\tfrac{1}{2}\sum_{a\in\Sigma} |\delta_a(w)|=\tfrac{1}{2}\tau(w)$.

    We now define how $P$ behaves for the boring blocks, denoted by  $Q_0,\ldots,Q_{2r-1}$. The first boring block $Q_0$ comes immediately before $H_1$. Each boring block $Q_j$, for $j\in\{1,\ldots,2r-1\}$ comes immediately after $H_j$ and immediately before $H_{j+1}$.  In almost every case, $P$ uses the path through the top row of $Q_j$.  The only exceptions are when $H_j$ or $H_{j+1}$ are bottom blocks. Note that, because of the global independence constraint, these two cases are mutually exclusive. See \cref{updownup}.

    \begin{figure}
        \centering{
            \begin{tabular}{ccc}
                \includegraphics{figs/crossings-1} &
                \includegraphics{figs/crossings-2} &
                \includegraphics{figs/crossings-3}
            \end{tabular}
            \caption{The paths taken by $P$ through boring blocks: A top path, a downup path, and an updown path.}
            \label{updownup}
        }
    \end{figure}

    \begin{compactenum}
        \item When $H_j$ is a bottom block, $P$ uses a path that begins at the bottom row of $Q_j$ but moves immediately to the top row of $Q_j$ and uses the entire path along the top row. We call this a \emph{downup} path.
        \item When $H_{j+1}$ is a bottom block, $P$ uses a path that begins at the top row of $Q_j$ and moves immediately to to the bottom row of $Q_j$ and uses the entire path along the bottom row.  We call this a \emph{updown} path.
    \end{compactenum}
    This completely defines the path $P:=v_1,\ldots,v_{2m}$. All that remains is to argue that the word $\rho:=\phi_w(v_1),\ldots,\phi_w(v_{2m})$ is anagramish.

    Observe that the number of downup paths and the number of updown paths that appear in $Q_0,\ldots,Q_{r-1}$ is exactly the same as the number of bottom blocks among $H_1,\ldots,H_{r-1}$ which is exactly $\beta$.  Similarly, the number of updown paths and downup paths that appear in $Q_{r+1},\ldots,Q_{2r-1}$ is exactly $\beta$.  Now every path that is neither downup nor updown uses the top row.  This implies that the sequence of colours contributed to $\rho$ by  the intersection of $P$ with $Q_0,\ldots,Q_{r-1}$ is a permutation of the sequence of colours contributed to $\rho$ by the intersection of $P$ with $Q_{r+1},\ldots,Q_{2r-1}$.  These two sequences cancel perfectly.

    Next, by construction, each pair of top and bottom blocks in $H_1,\ldots,H_{r-1}$ contributes exactly the same amount as a single matching zig-zag block in $H_{r+1},\ldots,H_{2r-1}$.  Specifically, if $x,y\in A_a$, $z\in B_a$, $H_x$ is a top block, $H_y$ is a bottom block and $H_z$ is a zig-zag block, then the contributions of $P_x$ and $P_y$ to $\rho$ cancels out the contribution of $P_z$. After doing this cancellation exhaustively, all that remains are top blocks, which also cancel each other perfectly.  This completes the proof.
\end{proof}


To be explicit, we finish the proof of \cref{main_vertex} by pointing out the contradiction between \cref{near_anagram_graph} and \cref{anagramish_path}:

\begin{proof}[Proof of \cref{main_vertex}]
    Assume for the sake of contradiction that there exists some $c\in\N$ such that $\afcn(G_n)\le c$ for each $n\in\N$.  With this assumption, \cref{near_anagram_graph} shows that for every $\epsilon>0$ and $r_0\in\N$ there exists a word $w\in L$ with $|w|\ge 2r_0$, $\tau(w)\le\epsilon r$, and such that $\phi_w$ is an anagram-free colouring of $G_{n_w}$.

    \cref{anagramish_path} shows that there are fixed values $\epsilon >0$ and $r_0\in \N$ such that, for any word $w\in L$ with $|w|\ge r_0$ and $\tau(w)\le\epsilon r$, the graph $G_{n_w}$ contain a path that is anagramish under $\phi_w$.  This certainly contradicts the fact that $\phi_w$ is an anagram-free colouring of $G_{n_w}$. We therefore conclude that, for every $c\in\N$ there exists an $n\in N$ such that $\afcn(G_n)> c$.
\end{proof}

% \todo[inline]{It would be nice to say something about the anagram-free chromatic index.  I'm pretty sure that it's constant for the $2\times n$ grid, but the result is not worth the effort.  More interesting would be a proof that its super-constant for the $2\times n$ grid with one diagonal in each square.  Almost everything we did above works except that we get hung up on a parity problem.  We can't do $2$ versus $1$ cancellation in $w$ but we can do $6$ versus $4$ cancellation. Everything works out except when the number of occurrences of some character is odd. In that case we get stuck with one uncancelled copy.}
%



\section{Proof of \cref{near_anagram_fourier}}
\label{near_anagram_proof}

% \todo[inline]{I suspect this lemma (and probably a better quantitative version) has a proof using Fourier approximation, but I don't know enough about Fourier approximation and my half-assed attempt to learn about it wasn't sufficient.}

All that remains is to prove \cref{near_anagram_fourier}, which we do now.

\begin{proof}[Proof of \cref{near_anagram_fourier}]
    First observe that, for any $\ell$-periodic word $w$, $|\Sigma_w|\le\ell$.
    Define an even-length word $t$ to be \emph{$a$-unbalanced} if $\tau_a(t)>\epsilon|t|/\ell$ and \emph{$a$-balanced} otherwise.  If $t$ is $a$-balanced for each $a\in\Sigma_t$ then $t$ is \emph{balanced}. Observe that, if $t$ is balanced then $\tau(t)\le |\Sigma_t|\epsilon|t|/\ell\le \epsilon|t|$. A word is \emph{everywhere unbalanced} if it contains no balanced factor of length $r\ge r_0$. Our goal therefore is to show that there is an upper bound $n:=n(\ell,\epsilon,r_0)$ on the length of any $\ell$-periodic everywhere unbalanced word.

    Let $h$ be a positive integer (that determines $n$ and whose value will be discussed later), and let $n:=r_02^{h}$. Let $w$ be an $\ell$-periodic everywhere unbalanced word of length $n$ over the alphabet $\Sigma$.  Assume, without loss of generality, that $r_0$ is a multiple of $\ell$.

    Consider the complete binary tree $T$ of height $h$ whose leaves, in order, are length-$r_0$ words whose concatenation is $w$ and for which each internal node is the factor obtained by concatenating the node's left and right child.
    % See \cref{binary_tree}.
    Note that for each $v\in V(T)$ and each $a\in\Sigma$, the fact that $w$ is $\ell$-periodic and $r_0$ is multiple of $\ell$ implies that $|v|_{a}\ge |v|/\ell$.

    % \begin{figure}
    %     \centering{
    %         \includegraphics[width=\textwidth]{figs/binary-tree-1}
    %     }
    %     \caption{Building a binary tree $T$ over the word $w:=4 3 5 3 2\ldots5 4 1 4$.}
    %     \label{binary_tree}
    % \end{figure}

  % For each node $v$ of $T$, let $h(v)$ denote the height of $v$'s subtree
  % and $w(v)=2^{h(v)}$ denote the length of the word $v$. For each
  % $i\in\Sigma$, let $w_i(v):=n_i(v)/s(v)$.  Note that $0\le w_i(v)\le
  % 1/2$ and that $\sum_{i\in\Sigma} w_i(v)=1$.  Furthermore, if $v$
  % has two children $x$ and $y$, then $w_i(v) = (w_i(x)+w_i(y))/2$.
  % The assumption that $w$ has no balanced factor implies $v$ is
  % $i$-unbalanced, for some $i\in\Sigma$.  Assign each internal node
  % $v$ of $T$ the \emph{label} $\ell(v):=\min\{i\in\Sigma: \mbox{$v$
  % is $i$-unbalanced}\}$.

  % \begin{figure}
  %   \centering{
  %      \includegraphics[width=\textwidth]{figs/binary-tree-3}
  %   }
  %   \todo[inline]{This is an old figure and needs updating.}
  %   \caption{The tree $T$ with the vector $(|v|_{1},\ldots,|v|_{5})$ for each
  %    internal node $v$.  The unbalanced index that defines $\ell(v)$ is highlited for each node.}
  %   \label{binary_tree_2}
  % \end{figure}

  For each $a\in\Sigma$, let $S_a:=\{v\in V(T): \text{$v$ is $a$-unbalanced}\}$. Since $w$ is everywhere unbalanced, $\bigcup_{a\in\Sigma} S_a=V(T)$. Therefore,
  \[
     (h+1)n = \sum_{v\in V(T)}|v|\le \sum_{a\in\Sigma} \sum_{v\in S_a} |v|
     \enspace .
  \]
  Therefore, there exists some $\alpha\in\Sigma$ such that $\sum_{v\in S_{\alpha}}|v|\ge (h+1)n/|\Sigma| \ge (h+1)n/\ell$.   At this point we are primarily concerned with appearances of $\alpha$, so let $X:=S_{\alpha}$, and, for each node $v\in V(T)$, let $W(v):=|v|_\alpha$.

  For each non-leaf node $v$ of $T$, let $R(v)$ denote a child of $v$ such that $W(R(v))\le \tfrac12\cdot W(v)$.  (It is helpful to think of $T$ as being ordered so that each right child $y$ with sibling $x$ has $W(y)\le W(x)$.)  For a non-leaf node $v\in X$ the fact that $v$ is $\alpha$-unbalanced implies that
  \[  W(R(v)) \le \tfrac{1}{2}\cdot W(v) - \tfrac{\epsilon}{2\ell}\cdot |v|
      \le (\tfrac12-\tfrac{\epsilon}{2\ell})W(v) \enspace .
  \]

  From this point on we use the following shorthands. For any $S\subseteq V(T)$, $L(S):=\sum_{v\in S}|v|$,
  % \todo{$L$ and $R$ are bad notation choices: $L$ for length, $R$ for right child}
  $W(S):=\sum_{v\in S}W(v)$, and $R(S)=\{R(v):v\in S\}$.  Summarizing, we have a complete binary tree $T$ of height $h$ and
  $X\subseteq V(T)$ with the following properties:
  \begin{compactenum}
    % \item For each $v\in V(T)$, $w(v) \le 1/2$.
    \item For each $v\in V(T)$,  $W(v)\ge |v|/\ell$.
    % \item For each internal node $v\in V(T)$ with children $x$ and $y$,
       % $w(v) = (w(x)+w(y))/2$.
    \item $L(X) \ge (h+1)n/\ell$.
    \item For each non-leaf node $v\in X$,
      $W(R(v)) \le (\tfrac{1}{2}-\tfrac{\epsilon}{2\ell})W(v)$.
  \end{compactenum}
  For each $i\in\{0,\ldots,h\}$, let $X_i\subseteq X$ denote the
  set of nodes $v\in X$ for which the path from the root of $T$ to $v$
  contains exactly $i$ nodes in $X$, excluding $v$.  See \cref{bigtree}. Observe that, since each node in $X_i$ has an ancestor in $X_{i-1}$,
  \[  n \ge L(X_0) \ge L(X_1) \ge \cdots\ge L(X_{h}) \enspace . \]

  We will show that there exists an integer $t:=t(\epsilon,\ell,r_0)$ such that, for each $i\in\{0,\ldots,h-t\}$,
  \begin{equation}
     L(X_{i+t}) \le (1-(1/2)^{t+1}) L(X_i) \enspace . \label{t}
  \end{equation}
  In this way,
  \begin{align*}
     (h+1)n/\ell
        \le L(X) & = \sum_{i=0}^{h} L(X_i) \\
           &\le \sum_{i=0}^{h} L(X_{t\floor{i/t}})
             & \text{(since $i\ge t\floor{i/t}$, so $L(X_i)\le L(X_{i\floor{i/t}}$))} \\
           & = t\cdot\sum_{i=0}^{h/t} L(X_{it})
             & \text{(for $h$ a multiple of $t$)} \\
           &\le t\cdot\sum_{i=0}^{\infty} (1-(1/2)^{t+1})^i L(X_0)
           & \text{(by \cref{t})}\\
           &\le tn\cdot \sum_{i=0}^{\infty} (1-(1/2)^{t+1})^i
           & \text{(since $|X_0|\le n$)} \\
           & = tn2^{t+1} \\
  \end{align*}
  which is a contradiction for sufficiently large $h$; in particular, for $h > \ell t2^{t+1}-1$.

  \begin{figure}
    \centering{
       \includegraphics[width=\textwidth]{figs/bigtree}
    }
    \caption{The partitioning of $X$ into $X_0,\ldots,X_h$. Shaded
    nodes are in $X$ and all nodes in $X_i$ are shaded with the same
    colour.   Starting with $A_0=X_0$, the elements of $A_0,\ldots,A_h$
    are highlighted (in orange).  The elements of $R(A_0),\ldots,R(A_h)$ are also highlighted (in pink).}
    \label{bigtree}
  \end{figure}

  It remains to establish \cref{t}, which we do now.  Fix some $i\in\{0,\ldots,h-1\}$, define $A_0:= X_i$ and, for each $j\ge 1$, define $A_j$ to be the subset of $X_{i+j}$ that are descendants of some node in $R(A_{j-1})$.  See \cref{bigtree}.  To upper bound $L(X_{i+t})$ observe that $X_{i+t}$ can be split into two sets $A_0'$ and $B$ defined as follows:  The nodes $A_0'$ do not have an ancestor in $R(A_0)$ and therefore $L(A_0')\le (1/2)L(A_0)$. The nodes in $B$ do have an ancestor in $R(A_0)$ and therefore have an ancestor in $A_1$.  Iterating this argument, we obtain
 \begin{align*}
      L(X_{i+t})
         &\le (1/2)L(A_0) + (1/2)L(A_1) + \cdots + (1/2)L(A_{t-1}) + L(A_t) \\
         &\le (1/2)L(A_0) + (1/4)L(A_0) + \cdots + (1/2)^t L(A_{0}) + L(A_t) \\
         &  = (1-(1/2)^t)L(A_0) + L(A_t) = (1-(1/2)^t)L(X_i) + L(A_t)  \enspace .
   \end{align*}
  So all that remains to establish \ref{t} is to prove that
  $L(A_t)\le (1/2)^{t+1}L(X_i)$.  To do this, observe that, for each $j\in\{1,\ldots,t\}$,
  \begin{equation}
      W(A_j)
        \le W(R(A_{j-1}))
        \le (\tfrac12-\tfrac{\epsilon}{2\ell})\cdot W(A_{j-1})
  \end{equation}
  which implies
  \[
       W(A_t)
       \le (\tfrac12-\tfrac{\epsilon}{2\ell})^t W(A_0) \le (\tfrac12-\tfrac{\epsilon}{2\ell})^t\cdot L(A_0)
       =  (\tfrac12-\tfrac{\epsilon}{2\ell})^t\cdot L(X_i)
  \]
  Since $w$ is $\ell$-periodic,
  \[
        L(A_t)\le \ell\cdot W(A_t) \le \ell\cdot(\tfrac12-\tfrac{\epsilon}{2\ell})^t\cdot L(X_i) \le L(X_i)/2^{t+1}
  \]
  for $t := \ceil{\log(2\ell)/\log((1/(1-\tfrac{\epsilon}{\ell}))}$.
\end{proof}

\section{Reflections}
\label{reflections}

Although an explicit upper bound on $n:=n(\epsilon,\ell,r_0)$ could be extracted from the proof of \cref{near_anagram_fourier} it would likely be far from tight.  We suspect that there is a Fourier analytic proof that would give better quantitative bounds.  We have not pursued this, because we have no idea how to explicitly upper bound $\ell$, for reasons discussed in the next paragraph.

\cref{periodicity} and its proof give absolutely no clues to help find a concrete bound on $\ell$ or to find a minimal set $\Xi$. Indeed, for some choices of $L$, doing so can be a difficult problem.  Consider the example where $|\Sigma|=5$ and $L$ is the language of all anagram free words in $\Sigma^*$. It is easy to see that this predicate $L$ is factor-closed and the result of \citet{pleasants:non-repetitive}, published in 1970, shows that this $L$ is infinite.  The question of whether $|\Xi|=4$ or $|\Xi|=5$ is then the question of determining whether there exist arbitrarily long anagram-free words on an alphabet of size $4$.  This was the open problem posed by \citet{erdos:some} in 1961 and again by \citet{brown:is} in 1971 and not resolved until 1992 when \citet{keranen:abelian,keranen:powerful} showed that the answer, in this case, is that $|\Xi|=4$.  However, if this were not the case, then determining $\ell$ would be the question of determining the length of the longest anagram-free word over an alphabet of size $4$.

Our proof uses \cref{periodicity} twice and each uses a language $L$ that is considerably more complicated than the language of anagram-free words. It seems unlikely that we will obtain concrete upper bounds on $\ell$ as a function of $c$ except, possibly, through the use of computer search. The resulting value $\ell$ is used in the application of \cref{near_anagram_fourier} and also within the proof of \cref{anagramish_path}.

\section*{Acknowledgement}

We would like to thank an anonymous referee for pointing out existing results and terminology from the field of combinatorics on words that has helped streamline the presentation in \cref{near_anagram_statement,vertex_colourings}.

\bibliographystyle{plainurlnat}
\bibliography{af2t}


\end{document}
